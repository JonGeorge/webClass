How to Install OpenVPN on Centos 6
----------------------------------


References
----------
https://webpatron.net/en/blog/sysadmin-notes/item/35-installing-configuring-and-using-openvpn-server-centos-6-6


Procedure
---------
 1. Install the openvpn software
    unix> sudo -s
    unix> cd /opt
    unix> get http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
    unix> rpm -Uvh epel-release-6*.rpm
    unix> yum install openvpn easy-rsa

 2. Get your .conf, .ovpn, and keys/ directory from your system administrator
    NOTE:  Have your system administrator export the openVPN certs using "Viscosity Bundle"
           -- So you should get a zip file that has something like this in it:
                 ---------  ---------- -----   ----
                         0  07-12-2016 16:49   Viscosity.visc/
                       427  07-12-2016 16:49   Viscosity.visc/config.conf
                      1595  07-12-2016 16:49   Viscosity.visc/ca.crt
                      1692  07-12-2016 16:49   Viscosity.visc/cert.crt
                       657  07-12-2016 16:49   Viscosity.visc/ta.key
                      1743  07-12-2016 16:49   Viscosity.visc/key.key
                 ---------                     -------

                
 3. Copy all files to /etc/openvpn/
 
 
 4. Modify the openVPN service to prompt you for a password
    unix> vi /etc/rc.d/init.d/openvpn
    
    # Change this line 
    $openvpn --daemon --writepid $piddir/$bn.pid --cd $work --config $c $script_security

    # To this line (We added the --askpass option)
    $openvpn --daemon --askpass --writepid $piddir/$bn.pid --cd $work --config $c $script_security

 
 5. Fix the problem in which openvpn will not push DNS information to your /etc/resolf.conf
    Problem:  Your /etc/resolv.conf file is missing the DNS entry

    Before running openvpn, your /etc/resolv.conf looks like this:
    # Generated by NetworkManager
    nameserver 10.2.0.30

    Upon openvpn startup, your /etc/resolv.conf should look like this:
    # Generated by NetworkManager
    nameserver 10.254.31.1     # This is the DNS for the openVPN
    nameserver 10.2.0.30

    WARNING:  The order within this file matters
    
    a. Tell openvpn to run the /etc/openvpn/update/resolv-conf.sh script on startup/shutdown
       Add these lines to your /etc/openvpn/something.conf file
          script-security 2
          up   /etc/openvpn/update-resolv-conf.sh
          down /etc/openvpn/update-resolv-conf.sh


    b. Create this file:  /etc/openvpn/update-resolv-conf.sh
       unix> vi /etc/openvpn/update-resolv-conf.sh
       
        #!/bin/bash -x
        ##########################################################
        # Filename:  update-resolv-conf.sh
        ##########################################################
        # Purpose:   To update the /etc/resolv.conf
        #            upon openvpn start and stop
        #
        ##########################################################
        lineMarker='# Additional DNS Server'
        lineToAddToResolv="nameserver 10.254.31.1   ${lineMarker}"
        RESOLV_CONF_FILE=/etc/resolv.conf
        RESOLV_CONF_TEMPFILE=/etc/resolv.conf.tmp
        
        case $script_type in
        up)
          # Add the extra line to /etc/resolv.conf (if it is not present)
          /bin/grep -q "$lineMarker" $RESOLV_CONF_FILE
          if [ $? == 1 ]
          then
                # The extra line is not in the resolv.conf file
                # So, add the extra line to the top of the file
                echo "$lineToAddToResolv" > $RESOLV_CONF_TEMPFILE
                cat $RESOLV_CONF_FILE >> $RESOLV_CONF_TEMPFILE
                /bin/cp -f -v $RESOLV_CONF_TEMPFILE $RESOLV_CONF_FILE
          fi
          ;;
        down)
          # Remove the extra line from /etc/resolf.conf (if it's present)
          /bin/grep -q "$lineMarker" $RESOLV_CONF_FILE
          if [ $? == 0 ]
          then
                # The extra line exists in the resolv.conf file
                # -- So, remove the extra line to the top of the file
                cat $RESOLV_CONF_FILE  | grep -v "# Additional DNS Server" > $RESOLV_CONF_TEMPFILE
                /bin/cp -f $RESOLV_CONF_TEMPFILE $RESOLV_CONF_FILE
          fi
          ;;
        esac
        
        exit 0

       
    c. Make this script executable
       unix> chmod ugo+x /etc/openvpn/update-resolv.conf
    
    
 6. Open a tail window on the /var/log/messages
    unix> tail -f /var/log/messages

     
 7. Start the openvpn service
    unix> service openvpn start
          Enter Private Key Password    <Enter the password your SA provided>
 
 8. Stop the openvpn service        
    unix> service openvpn start
    



